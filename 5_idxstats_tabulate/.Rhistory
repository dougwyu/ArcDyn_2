summary(compare(mitogenomes_data, mitogenomes_data_dplyr))
install.packages(c("backports", "bold", "bookdown", "broom", "callr", "classInt", "emmeans", "httpuv", "httr", "iNEXT", "jsonlite", "knitr", "markdown", "pillar", "prediction", "processx", "ps", "quantreg", "RcppParallel", "readr", "readxl", "ritis", "rmarkdown", "rsconnect", "rvcheck", "sf", "sjPlot", "solrium", "spam", "spData", "StanHeaders", "survey", "tidytree", "tweenr", "units"))
# setwd("D:/HY-data/OVASKAIN/all stuff/manuscripts/InPreparation/Tomas Greenland Methods")
setwd("~/Dropbox/Working_docs/Roslin_Greenland/2018/manuscript_methods/Supp_Info_data_and_R_scripts")
localDir = "."
dataDir = file.path(localDir, "Rdata")
# READ FILES AND RENAME TO UNIQUE NAMES (START) #################
load(file.path(dataDir, "arcdyn_suppfiles_mocks_COI_Barcodes_20181223.1.RData"))
# setwd("D:/HY-data/OVASKAIN/all stuff/manuscripts/InPreparation/Tomas Greenland Methods")
setwd("~/Dropbox/Working_docs/Roslin_Greenland/2018/manuscript_methods/Supp_Info_data_and_R_scripts")
localDir = "."
dataDir = file.path(localDir, "Rdata")
# READ FILES AND RENAME TO UNIQUE NAMES (START) #################
load(file.path(dataDir, "arcdyn_suppfiles_mocks_COI_Barcodes_20181223.1.RData"))
mock_data_COI = mock_data
mock_inputspp_COI = mock_inputspp
mock_design_COI = mock_design
load(file.path(dataDir, "arcdyn_suppfiles_mocks_20181223.1.RData"))
load(file.path(dataDir, "arcdyn_suppfiles_soups_COI_Barcodes_20181223.1.RData"))
mitogenomes_data_COI = mitogenomes_data
env_data_COI = env_data
env_design_COI = env_design
load(file.path(dataDir, "arcdyn_suppfiles_soups_20181223.1.RData"))
View(mock_design)
mock_design <- unique(mock_design)
View(mock_design_COI)
mitogenomes_data_COI = unique(mitogenomes_data_COI)
mitogenomes_data = unique(mitogenomes_data)
mitogenomes_data$BOLD = mitogenomes_data$Species_BOLD
View(mitogenomes_data)
for (i in 1:dim(mitogenomes_data)[1]){
tmp = mitogenomes_data$BOLD[i]
sta = regexpr("BOLD",tmp)
if(sta>0){
mitogenomes_data$BOLD[i] = substr(tmp,start=sta,stop=nchar(tmp))
} else
{
mitogenomes_data$BOLD[i] = paste0("BOLD:",substr(tmp,start=nchar(tmp)-6,stop=nchar(tmp)))
}
}
library("stringr", lib.loc="/Library/Frameworks/R.framework/Versions/3.5/Resources/library")
mitogenomes_data_COI$BOLD = mitogenomes_data_COI$Species_BOLD
for (i in 1:dim(mitogenomes_data_COI)[1]){
tmp = mitogenomes_data_COI$BOLD[i]
sta = regexpr("BOLD",tmp)
if(sta>0){
mitogenomes_data_COI$BOLD[i] = substr(tmp,start=sta,stop=nchar(tmp))
} else
{
mitogenomes_data_COI$BOLD[i] = paste0("BOLD:",substr(tmp,start=nchar(tmp)-6,stop=nchar(tmp)))
}
}
mitogenomes_data_COI$COI = mitogenomes_data_COI$mitogenome
mitogenomes_data_COI$COI_length = mitogenomes_data_COI$mt_length
mitogenomes_data_COI$mitogenome = NA
mitogenomes_data_COI$mt_length = NA
df <- data.frame(
a = rnorm(10),
b = rnorm(10),
c = rnorm(10),
d = rnorm(10)
)
# Replace the 1:ncol(df) sequence
for (i in seq_along(df)) {
print(median(df[[i]]))
}
# Change the value of df
df <- data.frame()
# Repeat for loop to verify there is no error
for (i in seq_along(df)) {
print(median(df[[i]]))
}
# Repeat for loop to verify there is no error
for (i in ncol(df)) {
print(median(df[[i]]))
}
# Change the value of df
df <- data.frame()
# Repeat for loop to verify there is no error
for (i in seq_along(df)) {
print(median(df[[i]]))
}
# If use ncol(df), it gives an error
df <- data.frame()
# Repeat for loop to verify there is no error
for (i in ncol(df)) {
print(median(df[[i]]))
}
# Repeat for loop to verify there is no error
for (i in seq(df)) {
print(median(df[[i]]))
}
# A2B2 resequenced (most of) the same samples as AB, but fortunately, Earlham Institute coded the AB samples as IPO3916/7_A1 and the A2B2 samples as PlateA/B_A1. So I can use this column to join with the other metadata
setwd("~/Dropbox/Working_docs/Roslin_Greenland/")
getwd()
# merge the files into one file AB
# sample identifier in soupdata has form IPO3916_A1, where IPO3916 is PlateA, IPO3917 is PlateB
fastq_read_counts_PlatesAB <- read_table("2016/bulk_samples/PlatesAB_EI_20160512/fastq_read_counts_PlatesAB.txt")
fastq_read_counts_PlatesAB <- fastq_read_counts_PlatesAB %>%
tidyr::separate(file, into = c(NA, "gpfs", "home", "b042", "greenland", "plates", "platessub", "BWA", "sample", "fastqfile"), sep = "/", remove = TRUE) %>%
mutate_at("sample", str_remove, "Sample_") %>% # remove "Sample_" from beginning of string
dplyr::select(sample, tot_num_seqs = num_seqs) %>%
dplyr::group_by(sample) %>%
summarise(tot_num_seqs = sum(tot_num_seqs))
# merge the files into one file A2B2
# sample identifier in soupdata has form PlateA_A1
fastq_read_counts_PlatesA2B2 <- read_table("2017/bulk_samples/PlatesA2B2/fastq_read_counts_PlatesA2B2.txt")
fastq_read_counts_PlatesA2B2 <- fastq_read_counts_PlatesA2B2 %>%
tidyr::separate(file, into = c(NA, "gpfs", "home", "b042", "greenland", "plates", "platessub", "BWA", "sample", "fastqfile"), sep = "/", remove = TRUE) %>%
mutate_at("sample", str_remove, "Sample_PRO1322_") %>% # remove "Sample_PRO1322_" from beginning of string
dplyr::select(sample, tot_num_seqs = num_seqs) %>%
dplyr::group_by(sample) %>%
summarise(tot_num_seqs = sum(tot_num_seqs))
# merge the files into one file EF
fastq_read_counts_PlatesEF <- read_table("2017/bulk_samples/PlatesEF/fastq_read_counts_PlatesEF.txt")
fastq_read_counts_PlatesEF <- fastq_read_counts_PlatesEF %>%
tidyr::separate(file, into = c(NA, "gpfs", "home", "b042", "greenland", "plates", "platessub", "fastqc", "BWA", "sample", "fastqfile"), sep = "/", remove = TRUE) %>%
mutate_at("sample", str_remove, "_[ACGT]{9}-[ACGT]{6}") %>% # remove index sequence from end of string, e.g. _TAGGTTAGG-GCCAAT
dplyr::select(sample, tot_num_seqs = num_seqs) %>%
dplyr::group_by(sample) %>%
summarise(tot_num_seqs = sum(tot_num_seqs))
# merge the files into one file GH
fastq_read_counts_PlatesGH <- read_table("2017/bulk_samples/PlatesGH/fastq_read_counts_PlatesGH.txt")
fastq_read_counts_PlatesGH <- fastq_read_counts_PlatesGH %>%
tidyr::separate(file, into = c(NA, "gpfs", "home", "b042", "greenland", "plates", "platessub", "BWA", "sample", "fastqfile"), sep = "/", remove = TRUE) %>%
mutate_at("sample", str_remove, "Sample_PRO1747_") %>% # remove index sequence from end of string, Sample_PRO1747_
dplyr::select(sample, tot_num_seqs = num_seqs) %>%
dplyr::group_by(sample) %>%
summarise(tot_num_seqs = sum(tot_num_seqs))
fastq_read_counts_PlatesABA2B2EFGH <- bind_rows(fastq_read_counts_PlatesAB, fastq_read_counts_PlatesA2B2, fastq_read_counts_PlatesEF, fastq_read_counts_PlatesGH)
# sanity check: should have: "IPO3916" "IPO3917" "PlateA"  "PlateB"  "PlateE"  "PlateF"  "PlateG"  "PlateH"
fastq_read_counts_PlatesABA2B2EFGH %>% dplyr::select(sample) %>% tidyr::separate(sample, sep = "_", into = c("sampleprefix", "samplesuffix")) %>% dplyr::count(sampleprefix) %>% arrange(sampleprefix)
setwd("~/Dropbox/Working_docs/Roslin_Greenland/2017/bulk_samples/PlatesABA2B2EFGH")
getwd()
# soups dataset
soupdata <- read_tsv("send_to_ArcDyn_collaborators_20180721_20180527_plus_taxonomies/idx_meta_genomecov_ABA2B2EFGH_minimap2_20180721.txt.zip")
## sanity check:  should have: "IPO3916" "IPO3917" "PlateA"  "PlateB"  "PlateE"  "PlateF"  "PlateG"  "PlateH"
soupdata %>% dplyr::select(sample) %>% tidyr::separate(sample, sep = "_", into = c("sampleprefix", "samplesuffix")) %>% dplyr::count(sampleprefix) %>% arrange(sampleprefix)
# mitogenomes_data
mitogenomes_data <- soupdata %>% dplyr::select(mitogenome, mt_length, Order, Family, Genus, Species_BOLD)
# env_design
## env_design, select sample, Date,
env_design <- soupdata %>% dplyr::select(sample = DateTrapEIRUN, date = Date, trap = Trap, run = EI_RUN, lysis_buffer_orig_total_ul, lysis_buffer_purified_ul, lysis_buffer_proportion)
## spike input DNA amount
## Plates AB & A2B2:  10, 20, 40 ng;  Plates EF & GH:  0.2, 0.4, 0.8 ng, for Bombycidae, Mordellidae, Elateridae, respectively
env_design <- env_design %>% mutate(
Lepidoptera_Bombycidae_Bombyx_mori_COI = case_when(
run == "idx_meta_genomecov_AB" ~ 10,
run == "idx_meta_genomecov_A2B2" ~ 10,
run == "idx_meta_genomecov_EF" ~ 0.2,
run == "idx_meta_genomecov_GH" ~ 0.2
)
)
env_design <- env_design %>% mutate(
Coleoptera_Mordellidae_COI = case_when(
run == "idx_meta_genomecov_AB" ~ 20,
run == "idx_meta_genomecov_A2B2" ~ 20,
run == "idx_meta_genomecov_EF" ~ 0.4,
run == "idx_meta_genomecov_GH" ~ 0.4
)
)
env_design <- env_design %>% mutate(
Coleoptera_Elateridae_COI = case_when(
run == "idx_meta_genomecov_AB" ~ 40,
run == "idx_meta_genomecov_A2B2" ~ 40,
run == "idx_meta_genomecov_EF" ~ 0.8,
run == "idx_meta_genomecov_GH" ~ 0.8
)
)
# env_data
## make long-format dataset of the COI_spike mapped reads, one row per sample and spike_species
## change names of the COI spike mapped reads to omit the ng portion
env_spikes <- soupdata %>%
dplyr::select(sample = DateTrapEIRUN,
Lepidoptera_Bombycidae_Bombyx_mori_COI = Lepidoptera_Bombycidae_Bombyx_mori_10ng_COI,
Coleoptera_Mordellidae_COI = Coleoptera_Mordellidae_20ng_COI,
Coleoptera_Elateridae_COI = Coleoptera_Elateridae_40ng_COI,
sampleorig = sample) %>%
tidyr::gather(species, mapped_reads_mitogenome,
Lepidoptera_Bombycidae_Bombyx_mori_COI,
Coleoptera_Mordellidae_COI, Coleoptera_Elateridae_COI) %>%
dplyr::distinct(sample, species, mapped_reads_mitogenome, sampleorig)
# extract mapped reads and pct_coverage for each mitogenome in each sample
env_data <- soupdata %>%
dplyr::select(sample = DateTrapEIRUN, species = mitogenome, mapped_reads_mitogenome = mapped_reads, pct_coverage_mitogenome = pct_coverage, sampleorig = sample)
# bind rows with env_spikes dataset, with different cols for mapped reads to mitogenomes and COI spike
env_data <- bind_rows(env_data, env_spikes) %>% arrange(sample)
# add fastq read counts to dataset,
env_data <- left_join(env_data, fastq_read_counts_PlatesABA2B2EFGH, by = c("sampleorig" = "sample")) %>% dplyr::select(-sampleorig)
# create a column indicating mitogenome or COI_spike species, change column order
env_data$mito_spike <- if_else(grepl("_COI$", env_data$species), "spike", "mitogenome")
env_data <- env_data %>% dplyr::select(sample, mito_spike, everything())
# mock datasets
setwd("~/Dropbox/Working_docs/Roslin_Greenland/2017/bulk_samples/PlatesABA2B2EFGH")
mockall <- read_excel("send_to_ArcDyn_collaborators_20180527/for_Otso/minimap2_mock_data/mocks_idx_meta_genomecov_PlatesEFGH_20180527.xlsx", sheet = "mocks_idx_meta_genomecov_Plates", na = "NA")
# add fastq read counts to dataset,
mockall <- left_join(mockall, fastq_read_counts_PlatesABA2B2EFGH, by = c("sample" = "sample"))
## to make mock_inputspp
### extract COI_spike columns, make a long-format dataset (with gather), change column name to mitogenome, reduce to unique COI_spike names, and add a new column with index numbers (1,2,3). Change COI_spike colnames to omit 10/20/40ng from name
mock_spikes <- mockall %>%
dplyr::select(Lepidoptera_Bombycidae_Bombyx_mori_COI = Lepidoptera_Bombycidae_Bombyx_mori_10ng_COI, Coleoptera_Mordellidae_COI = Coleoptera_Mordellidae_20ng_COI, Coleoptera_Elateridae_COI = Coleoptera_Elateridae_40ng_COI) %>%
tidyr::gather(species, mapped_reads, Lepidoptera_Bombycidae_Bombyx_mori_COI, Coleoptera_Mordellidae_COI, Coleoptera_Elateridae_COI) %>%
dplyr::select(mitogenome = species) %>%
dplyr::distinct(mitogenome)
mock_spikes <- cbind(mock_spikes, order = seq(nrow(mock_spikes)))
### extract mitogenome column, reduce to unique mitogenome names, and add a new column with index numbers (1,...,308)
mock_mitogenomes <- mockall %>%
dplyr::select(mitogenome, mt_length) %>%
dplyr::distinct(mitogenome, mt_length)
mock_mitogenomes <- cbind(mock_mitogenomes, order = seq(nrow(mock_mitogenomes)))
### bind mock_mitogenomes and mock_spikes, add spike or sp as prefix, merge with index number, change column order
mock_inputspp <- dplyr::bind_rows(mock_mitogenomes, mock_spikes)
mock_inputspp$species <- if_else(grepl("_COI$", mock_inputspp$mitogenome), "spike", "sp")
mock_inputspp <- mock_inputspp %>%
unite(species, c("species", "order"), sep = "") %>%
dplyr::select(species, mitogenome, mt_length)
## to make mock_design
## sample	experiment	run	lysis	input species	input mount
### select columns except for the COI_spike columns
mock_design <- mockall %>%
dplyr::select(plate = Plate, shortname = Expt_shortname, experiment, run = Replicate, mitogenome_spike = mitogenome, input_amount = inputDNA_ng)
### left_join mock_inputspp. Do not include lysis (not necessary), do include mitogenome name
mock_design <- dplyr::left_join(mock_design, mock_inputspp, by = c("mitogenome_spike" = "mitogenome")) %>%
dplyr::select(plate, shortname, experiment, run, mitogenome_spike, input_species = species, input_amount)
### select COI_spike species
mock_spikes <- mockall %>% dplyr::select(plate = Plate, shortname = Expt_shortname, experiment, run = Replicate, Lepidoptera_Bombycidae_Bombyx_mori_COI = Lepidoptera_Bombycidae_Bombyx_mori_10ng_COI, Coleoptera_Mordellidae_COI = Coleoptera_Mordellidae_20ng_COI, Coleoptera_Elateridae_COI = Coleoptera_Elateridae_40ng_COI) %>%
tidyr::gather(mitogenome_spike, mapped_reads_COI, Lepidoptera_Bombycidae_Bombyx_mori_COI, Coleoptera_Mordellidae_COI, Coleoptera_Elateridae_COI) #%>%
dplyr::distinct(plate, shortname, experiment, run, mitogenome_spike, mapped_reads_COI)
### add input DNA amounts (since only PlatesEF & GH, the amts are 0.2, 0.4, 0.8 only)
mock_spikes <- mock_spikes %>% mutate(
input_amount = case_when(
mitogenome_spike == "Lepidoptera_Bombycidae_Bombyx_mori_COI" ~ 0.2,
mitogenome_spike == "Coleoptera_Mordellidae_COI" ~ 0.4,
mitogenome_spike == "Coleoptera_Elateridae_COI" ~ 0.8
)
)
mock_spikes <- left_join(mock_spikes, mock_inputspp, by = c("mitogenome_spike" = "mitogenome")) # %>% tidyr::separate(sample, c(NA, "Run"), sep = "_", remove = FALSE) #
mock_spikes <- mock_spikes %>% dplyr::select(plate, shortname, experiment, run, mitogenome_spike, input_species = species, input_amount)
mock_design <- bind_rows(mock_design, mock_spikes) %>% arrange(plate, shortname, run) # 4976 obs
mock_design <- mock_design %>% unite("sample", c(plate, shortname, run), remove = FALSE)
names(mock_design)
# A2B2 resequenced (most of) the same samples as AB, but fortunately, Earlham Institute coded the AB samples as IPO3916/7_A1 and the A2B2 samples as PlateA/B_A1. So I can use this column to join with the other metadata
setwd("~/Dropbox/Working_docs/Roslin_Greenland/")
getwd()
# merge the files into one file AB
# sample identifier in soupdata has form IPO3916_A1, where IPO3916 is PlateA, IPO3917 is PlateB
fastq_read_counts_PlatesAB <- read_table("2016/bulk_samples/PlatesAB_EI_20160512/fastq_read_counts_PlatesAB.txt")
fastq_read_counts_PlatesAB <- fastq_read_counts_PlatesAB %>%
tidyr::separate(file, into = c(NA, "gpfs", "home", "b042", "greenland", "plates", "platessub", "BWA", "sample", "fastqfile"), sep = "/", remove = TRUE) %>%
mutate_at("sample", str_remove, "Sample_") %>% # remove "Sample_" from beginning of string
dplyr::select(sample, tot_num_seqs = num_seqs) %>%
dplyr::group_by(sample) %>%
summarise(tot_num_seqs = sum(tot_num_seqs))
# merge the files into one file A2B2
# sample identifier in soupdata has form PlateA_A1
fastq_read_counts_PlatesA2B2 <- read_table("2017/bulk_samples/PlatesA2B2/fastq_read_counts_PlatesA2B2.txt")
fastq_read_counts_PlatesA2B2 <- fastq_read_counts_PlatesA2B2 %>%
tidyr::separate(file, into = c(NA, "gpfs", "home", "b042", "greenland", "plates", "platessub", "BWA", "sample", "fastqfile"), sep = "/", remove = TRUE) %>%
mutate_at("sample", str_remove, "Sample_PRO1322_") %>% # remove "Sample_PRO1322_" from beginning of string
dplyr::select(sample, tot_num_seqs = num_seqs) %>%
dplyr::group_by(sample) %>%
summarise(tot_num_seqs = sum(tot_num_seqs))
# merge the files into one file EF
fastq_read_counts_PlatesEF <- read_table("2017/bulk_samples/PlatesEF/fastq_read_counts_PlatesEF.txt")
fastq_read_counts_PlatesEF <- fastq_read_counts_PlatesEF %>%
tidyr::separate(file, into = c(NA, "gpfs", "home", "b042", "greenland", "plates", "platessub", "fastqc", "BWA", "sample", "fastqfile"), sep = "/", remove = TRUE) %>%
mutate_at("sample", str_remove, "_[ACGT]{9}-[ACGT]{6}") %>% # remove index sequence from end of string, e.g. _TAGGTTAGG-GCCAAT
dplyr::select(sample, tot_num_seqs = num_seqs) %>%
dplyr::group_by(sample) %>%
summarise(tot_num_seqs = sum(tot_num_seqs))
# merge the files into one file GH
fastq_read_counts_PlatesGH <- read_table("2017/bulk_samples/PlatesGH/fastq_read_counts_PlatesGH.txt")
fastq_read_counts_PlatesGH <- fastq_read_counts_PlatesGH %>%
tidyr::separate(file, into = c(NA, "gpfs", "home", "b042", "greenland", "plates", "platessub", "BWA", "sample", "fastqfile"), sep = "/", remove = TRUE) %>%
mutate_at("sample", str_remove, "Sample_PRO1747_") %>% # remove index sequence from end of string, Sample_PRO1747_
dplyr::select(sample, tot_num_seqs = num_seqs) %>%
dplyr::group_by(sample) %>%
summarise(tot_num_seqs = sum(tot_num_seqs))
fastq_read_counts_PlatesABA2B2EFGH <- bind_rows(fastq_read_counts_PlatesAB, fastq_read_counts_PlatesA2B2, fastq_read_counts_PlatesEF, fastq_read_counts_PlatesGH)
# sanity check: should have: "IPO3916" "IPO3917" "PlateA"  "PlateB"  "PlateE"  "PlateF"  "PlateG"  "PlateH"
fastq_read_counts_PlatesABA2B2EFGH %>% dplyr::select(sample) %>% tidyr::separate(sample, sep = "_", into = c("sampleprefix", "samplesuffix")) %>% dplyr::count(sampleprefix) %>% arrange(sampleprefix)
# A2B2 resequenced (most of) the same samples as AB, but fortunately, Earlham Institute coded the AB samples as IPO3916/7_A1 and the A2B2 samples as PlateA/B_A1. So I can use this column to join with the other metadata
setwd("~/Dropbox/Working_docs/Roslin_Greenland/")
getwd()
# merge the files into one file AB
# sample identifier in soupdata has form IPO3916_A1, where IPO3916 is PlateA, IPO3917 is PlateB
fastq_read_counts_PlatesAB <- read_table("2016/bulk_samples/PlatesAB_EI_20160512/fastq_read_counts_PlatesAB.txt")
# rm(list=ls())
library(tidyverse)
# ── Attaching packages ──────────────────────────────────────────────────────────────────────────────────── tidyverse 1.2.1 ──
# ✔ ggplot2 2.2.1     ✔ purrr   0.2.4
# ✔ tibble  1.4.2     ✔ dplyr   0.7.4
# ✔ tidyr   0.8.0     ✔ stringr 1.2.0
# ✔ readr   1.1.1     ✔ forcats 0.2.0
# ── Conflicts ─────────────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──
# ✖ dplyr::filter() masks stats::filter()
# ✖ dplyr::lag()    masks stats::lag()
library(readxl)
library(lubridate)
library(knitr)
library(beepr)
library(hablar)
# library(parallel)
# library(knitr)
# library(lattice)
# library(beeswarm)
# library(sjPlot)
# library(openxlsx)
# library(RColorBrewer)
# A2B2 resequenced (most of) the same samples as AB, but fortunately, Earlham Institute coded the AB samples as IPO3916/7_A1 and the A2B2 samples as PlateA/B_A1. So I can use this column to join with the other metadata
setwd("~/Dropbox/Working_docs/Roslin_Greenland/")
getwd()
# merge the files into one file AB
# sample identifier in soupdata has form IPO3916_A1, where IPO3916 is PlateA, IPO3917 is PlateB
fastq_read_counts_PlatesAB <- read_table("2016/bulk_samples/PlatesAB_EI_20160512/fastq_read_counts_PlatesAB.txt")
fastq_read_counts_PlatesAB <- fastq_read_counts_PlatesAB %>%
tidyr::separate(file, into = c(NA, "gpfs", "home", "b042", "greenland", "plates", "platessub", "BWA", "sample", "fastqfile"), sep = "/", remove = TRUE) %>%
mutate_at("sample", str_remove, "Sample_") %>% # remove "Sample_" from beginning of string
dplyr::select(sample, tot_num_seqs = num_seqs) %>%
dplyr::group_by(sample) %>%
summarise(tot_num_seqs = sum(tot_num_seqs))
# merge the files into one file A2B2
# sample identifier in soupdata has form PlateA_A1
fastq_read_counts_PlatesA2B2 <- read_table("2017/bulk_samples/PlatesA2B2/fastq_read_counts_PlatesA2B2.txt")
fastq_read_counts_PlatesA2B2 <- fastq_read_counts_PlatesA2B2 %>%
tidyr::separate(file, into = c(NA, "gpfs", "home", "b042", "greenland", "plates", "platessub", "BWA", "sample", "fastqfile"), sep = "/", remove = TRUE) %>%
mutate_at("sample", str_remove, "Sample_PRO1322_") %>% # remove "Sample_PRO1322_" from beginning of string
dplyr::select(sample, tot_num_seqs = num_seqs) %>%
dplyr::group_by(sample) %>%
summarise(tot_num_seqs = sum(tot_num_seqs))
# merge the files into one file EF
fastq_read_counts_PlatesEF <- read_table("2017/bulk_samples/PlatesEF/fastq_read_counts_PlatesEF.txt")
fastq_read_counts_PlatesEF <- fastq_read_counts_PlatesEF %>%
tidyr::separate(file, into = c(NA, "gpfs", "home", "b042", "greenland", "plates", "platessub", "fastqc", "BWA", "sample", "fastqfile"), sep = "/", remove = TRUE) %>%
mutate_at("sample", str_remove, "_[ACGT]{9}-[ACGT]{6}") %>% # remove index sequence from end of string, e.g. _TAGGTTAGG-GCCAAT
dplyr::select(sample, tot_num_seqs = num_seqs) %>%
dplyr::group_by(sample) %>%
summarise(tot_num_seqs = sum(tot_num_seqs))
# merge the files into one file GH
fastq_read_counts_PlatesGH <- read_table("2017/bulk_samples/PlatesGH/fastq_read_counts_PlatesGH.txt")
fastq_read_counts_PlatesGH <- fastq_read_counts_PlatesGH %>%
tidyr::separate(file, into = c(NA, "gpfs", "home", "b042", "greenland", "plates", "platessub", "BWA", "sample", "fastqfile"), sep = "/", remove = TRUE) %>%
mutate_at("sample", str_remove, "Sample_PRO1747_") %>% # remove index sequence from end of string, Sample_PRO1747_
dplyr::select(sample, tot_num_seqs = num_seqs) %>%
dplyr::group_by(sample) %>%
summarise(tot_num_seqs = sum(tot_num_seqs))
fastq_read_counts_PlatesABA2B2EFGH <- bind_rows(fastq_read_counts_PlatesAB, fastq_read_counts_PlatesA2B2, fastq_read_counts_PlatesEF, fastq_read_counts_PlatesGH)
# sanity check: should have: "IPO3916" "IPO3917" "PlateA"  "PlateB"  "PlateE"  "PlateF"  "PlateG"  "PlateH"
fastq_read_counts_PlatesABA2B2EFGH %>% dplyr::select(sample) %>% tidyr::separate(sample, sep = "_", into = c("sampleprefix", "samplesuffix")) %>% dplyr::count(sampleprefix) %>% arrange(sampleprefix)
setwd("~/Dropbox/Working_docs/Roslin_Greenland/2017/bulk_samples/PlatesABA2B2EFGH")
getwd()
# soups dataset
soupdata <- read_tsv("send_to_ArcDyn_collaborators_20180721_20180527_plus_taxonomies/idx_meta_genomecov_ABA2B2EFGH_minimap2_20180721.txt.zip")
## sanity check:  should have: "IPO3916" "IPO3917" "PlateA"  "PlateB"  "PlateE"  "PlateF"  "PlateG"  "PlateH"
soupdata %>% dplyr::select(sample) %>% tidyr::separate(sample, sep = "_", into = c("sampleprefix", "samplesuffix")) %>% dplyr::count(sampleprefix) %>% arrange(sampleprefix)
# mitogenomes_data
mitogenomes_data <- soupdata %>% dplyr::select(mitogenome, mt_length, Order, Family, Genus, Species_BOLD)
# env_design
## env_design, select sample, Date,
env_design <- soupdata %>% dplyr::select(sample = DateTrapEIRUN, date = Date, trap = Trap, run = EI_RUN, lysis_buffer_orig_total_ul, lysis_buffer_purified_ul, lysis_buffer_proportion)
## spike input DNA amount
## Plates AB & A2B2:  10, 20, 40 ng;  Plates EF & GH:  0.2, 0.4, 0.8 ng, for Bombycidae, Mordellidae, Elateridae, respectively
env_design <- env_design %>% mutate(
Lepidoptera_Bombycidae_Bombyx_mori_COI = case_when(
run == "idx_meta_genomecov_AB" ~ 10,
run == "idx_meta_genomecov_A2B2" ~ 10,
run == "idx_meta_genomecov_EF" ~ 0.2,
run == "idx_meta_genomecov_GH" ~ 0.2
)
)
env_design <- env_design %>% mutate(
Coleoptera_Mordellidae_COI = case_when(
run == "idx_meta_genomecov_AB" ~ 20,
run == "idx_meta_genomecov_A2B2" ~ 20,
run == "idx_meta_genomecov_EF" ~ 0.4,
run == "idx_meta_genomecov_GH" ~ 0.4
)
)
env_design <- env_design %>% mutate(
Coleoptera_Elateridae_COI = case_when(
run == "idx_meta_genomecov_AB" ~ 40,
run == "idx_meta_genomecov_A2B2" ~ 40,
run == "idx_meta_genomecov_EF" ~ 0.8,
run == "idx_meta_genomecov_GH" ~ 0.8
)
)
# env_data
## make long-format dataset of the COI_spike mapped reads, one row per sample and spike_species
## change names of the COI spike mapped reads to omit the ng portion
env_spikes <- soupdata %>%
dplyr::select(sample = DateTrapEIRUN,
Lepidoptera_Bombycidae_Bombyx_mori_COI = Lepidoptera_Bombycidae_Bombyx_mori_10ng_COI,
Coleoptera_Mordellidae_COI = Coleoptera_Mordellidae_20ng_COI,
Coleoptera_Elateridae_COI = Coleoptera_Elateridae_40ng_COI,
sampleorig = sample) %>%
tidyr::gather(species, mapped_reads_mitogenome,
Lepidoptera_Bombycidae_Bombyx_mori_COI,
Coleoptera_Mordellidae_COI, Coleoptera_Elateridae_COI) %>%
dplyr::distinct(sample, species, mapped_reads_mitogenome, sampleorig)
# extract mapped reads and pct_coverage for each mitogenome in each sample
env_data <- soupdata %>%
dplyr::select(sample = DateTrapEIRUN, species = mitogenome, mapped_reads_mitogenome = mapped_reads, pct_coverage_mitogenome = pct_coverage, sampleorig = sample)
# bind rows with env_spikes dataset, with different cols for mapped reads to mitogenomes and COI spike
env_data <- bind_rows(env_data, env_spikes) %>% arrange(sample)
# add fastq read counts to dataset,
env_data <- left_join(env_data, fastq_read_counts_PlatesABA2B2EFGH, by = c("sampleorig" = "sample")) %>% dplyr::select(-sampleorig)
# create a column indicating mitogenome or COI_spike species, change column order
env_data$mito_spike <- if_else(grepl("_COI$", env_data$species), "spike", "mitogenome")
env_data <- env_data %>% dplyr::select(sample, mito_spike, everything())
# mock datasets
setwd("~/Dropbox/Working_docs/Roslin_Greenland/2017/bulk_samples/PlatesABA2B2EFGH")
mockall <- read_excel("send_to_ArcDyn_collaborators_20180527/for_Otso/minimap2_mock_data/mocks_idx_meta_genomecov_PlatesEFGH_20180527.xlsx", sheet = "mocks_idx_meta_genomecov_Plates", na = "NA")
# add fastq read counts to dataset,
mockall <- left_join(mockall, fastq_read_counts_PlatesABA2B2EFGH, by = c("sample" = "sample"))
## to make mock_inputspp
### extract COI_spike columns, make a long-format dataset (with gather), change column name to mitogenome, reduce to unique COI_spike names, and add a new column with index numbers (1,2,3). Change COI_spike colnames to omit 10/20/40ng from name
mock_spikes <- mockall %>%
dplyr::select(Lepidoptera_Bombycidae_Bombyx_mori_COI = Lepidoptera_Bombycidae_Bombyx_mori_10ng_COI, Coleoptera_Mordellidae_COI = Coleoptera_Mordellidae_20ng_COI, Coleoptera_Elateridae_COI = Coleoptera_Elateridae_40ng_COI) %>%
tidyr::gather(species, mapped_reads, Lepidoptera_Bombycidae_Bombyx_mori_COI, Coleoptera_Mordellidae_COI, Coleoptera_Elateridae_COI) %>%
dplyr::select(mitogenome = species) %>%
dplyr::distinct(mitogenome)
mock_spikes <- cbind(mock_spikes, order = seq(nrow(mock_spikes)))
### extract mitogenome column, reduce to unique mitogenome names, and add a new column with index numbers (1,...,308)
mock_mitogenomes <- mockall %>%
dplyr::select(mitogenome, mt_length) %>%
dplyr::distinct(mitogenome, mt_length)
mock_mitogenomes <- cbind(mock_mitogenomes, order = seq(nrow(mock_mitogenomes)))
### bind mock_mitogenomes and mock_spikes, add spike or sp as prefix, merge with index number, change column order
mock_inputspp <- dplyr::bind_rows(mock_mitogenomes, mock_spikes)
mock_inputspp$species <- if_else(grepl("_COI$", mock_inputspp$mitogenome), "spike", "sp")
mock_inputspp <- mock_inputspp %>%
unite(species, c("species", "order"), sep = "") %>%
dplyr::select(species, mitogenome, mt_length)
## to make mock_design
## sample	experiment	run	lysis	input species	input mount
### select columns except for the COI_spike columns
mock_design <- mockall %>%
dplyr::select(plate = Plate, shortname = Expt_shortname, experiment, run = Replicate, mitogenome_spike = mitogenome, input_amount = inputDNA_ng)
### left_join mock_inputspp. Do not include lysis (not necessary), do include mitogenome name
mock_design <- dplyr::left_join(mock_design, mock_inputspp, by = c("mitogenome_spike" = "mitogenome")) %>%
dplyr::select(plate, shortname, experiment, run, mitogenome_spike, input_species = species, input_amount)
### select COI_spike species
mock_spikes <- mockall %>% dplyr::select(plate = Plate, shortname = Expt_shortname, experiment, run = Replicate, Lepidoptera_Bombycidae_Bombyx_mori_COI = Lepidoptera_Bombycidae_Bombyx_mori_10ng_COI, Coleoptera_Mordellidae_COI = Coleoptera_Mordellidae_20ng_COI, Coleoptera_Elateridae_COI = Coleoptera_Elateridae_40ng_COI) %>%
tidyr::gather(mitogenome_spike, mapped_reads_COI, Lepidoptera_Bombycidae_Bombyx_mori_COI, Coleoptera_Mordellidae_COI, Coleoptera_Elateridae_COI) #%>%
dplyr::distinct(plate, shortname, experiment, run, mitogenome_spike, mapped_reads_COI)
### add input DNA amounts (since only PlatesEF & GH, the amts are 0.2, 0.4, 0.8 only)
mock_spikes <- mock_spikes %>% mutate(
input_amount = case_when(
mitogenome_spike == "Lepidoptera_Bombycidae_Bombyx_mori_COI" ~ 0.2,
mitogenome_spike == "Coleoptera_Mordellidae_COI" ~ 0.4,
mitogenome_spike == "Coleoptera_Elateridae_COI" ~ 0.8
)
)
mock_spikes <- left_join(mock_spikes, mock_inputspp, by = c("mitogenome_spike" = "mitogenome")) # %>% tidyr::separate(sample, c(NA, "Run"), sep = "_", remove = FALSE) #
mock_spikes <- mock_spikes %>% dplyr::select(plate, shortname, experiment, run, mitogenome_spike, input_species = species, input_amount)
mock_design <- bind_rows(mock_design, mock_spikes) %>% arrange(plate, shortname, run) # 4976 obs
mock_design <- mock_design %>% unite("sample", c(plate, shortname, run), remove = FALSE)
names(mock_design)
View(mock_design)
## to make mock_design
## sample	experiment	run	lysis	input species	input mount
### select columns except for the COI_spike columns
mock_design <- mockall %>%
dplyr::select(plate = Plate, shortname = Expt_shortname, experiment, run = Replicate, mitogenome_spike = mitogenome, input_amount = inputDNA_ng)
View(mock_design)
### left_join mock_inputspp. Do not include lysis (not necessary), do include mitogenome name
mock_design <- dplyr::left_join(mock_design, mock_inputspp, by = c("mitogenome_spike" = "mitogenome")) %>%
dplyr::select(plate, shortname, experiment, run, mitogenome_spike, input_species = species, input_amount)
### select COI_spike species
mock_spikes <- mockall %>% dplyr::select(plate = Plate, shortname = Expt_shortname, experiment, run = Replicate, Lepidoptera_Bombycidae_Bombyx_mori_COI = Lepidoptera_Bombycidae_Bombyx_mori_10ng_COI, Coleoptera_Mordellidae_COI = Coleoptera_Mordellidae_20ng_COI, Coleoptera_Elateridae_COI = Coleoptera_Elateridae_40ng_COI) %>%
tidyr::gather(mitogenome_spike, mapped_reads_COI, Lepidoptera_Bombycidae_Bombyx_mori_COI, Coleoptera_Mordellidae_COI, Coleoptera_Elateridae_COI) #%>%
dplyr::distinct(plate, shortname, experiment, run, mitogenome_spike, mapped_reads_COI)
View(mock_spikes)
### select COI_spike species
mock_spikes <- mockall %>% dplyr::select(plate = Plate, shortname = Expt_shortname, experiment, run = Replicate, Lepidoptera_Bombycidae_Bombyx_mori_COI = Lepidoptera_Bombycidae_Bombyx_mori_10ng_COI, Coleoptera_Mordellidae_COI = Coleoptera_Mordellidae_20ng_COI, Coleoptera_Elateridae_COI = Coleoptera_Elateridae_40ng_COI) %>%
tidyr::gather(mitogenome_spike, mapped_reads_COI, Lepidoptera_Bombycidae_Bombyx_mori_COI, Coleoptera_Mordellidae_COI, Coleoptera_Elateridae_COI) %>%
dplyr::distinct(plate, shortname, experiment, run, mitogenome_spike, mapped_reads_COI)
View(mock_design)
### select COI_spike species
mock_spikes <- mockall %>% dplyr::select(plate = Plate, shortname = Expt_shortname, experiment, run = Replicate, Lepidoptera_Bombycidae_Bombyx_mori_COI = Lepidoptera_Bombycidae_Bombyx_mori_10ng_COI, Coleoptera_Mordellidae_COI = Coleoptera_Mordellidae_20ng_COI, Coleoptera_Elateridae_COI = Coleoptera_Elateridae_40ng_COI) %>%
tidyr::gather(mitogenome_spike, mapped_reads_COI, Lepidoptera_Bombycidae_Bombyx_mori_COI, Coleoptera_Mordellidae_COI, Coleoptera_Elateridae_COI) # %>%
View(mock_spikes)
### select COI_spike species
mock_spikes <- mockall %>% dplyr::select(plate = Plate, shortname = Expt_shortname, experiment, run = Replicate, Lepidoptera_Bombycidae_Bombyx_mori_COI = Lepidoptera_Bombycidae_Bombyx_mori_10ng_COI, Coleoptera_Mordellidae_COI = Coleoptera_Mordellidae_20ng_COI, Coleoptera_Elateridae_COI = Coleoptera_Elateridae_40ng_COI) %>%
tidyr::gather(mitogenome_spike, mapped_reads_COI, Lepidoptera_Bombycidae_Bombyx_mori_COI, Coleoptera_Mordellidae_COI, Coleoptera_Elateridae_COI) %>%
dplyr::distinct(plate, shortname, experiment, run, mitogenome_spike, mapped_reads_COI)
View(mock_spikes)
### add input DNA amounts (since only PlatesEF & GH, the amts are 0.2, 0.4, 0.8 only)
mock_spikes <- mock_spikes %>% mutate(
input_amount = case_when(
mitogenome_spike == "Lepidoptera_Bombycidae_Bombyx_mori_COI" ~ 0.2,
mitogenome_spike == "Coleoptera_Mordellidae_COI" ~ 0.4,
mitogenome_spike == "Coleoptera_Elateridae_COI" ~ 0.8
)
)
mock_spikes <- left_join(mock_spikes, mock_inputspp, by = c("mitogenome_spike" = "mitogenome")) # %>% tidyr::separate(sample, c(NA, "Run"), sep = "_", remove = FALSE) #
mock_spikes <- mock_spikes %>% dplyr::select(plate, shortname, experiment, run, mitogenome_spike, input_species = species, input_amount)
View(mock_spikes)
mock_design <- bind_rows(mock_design, mock_spikes) %>% arrange(plate, shortname, run) # 4976 obs
mock_design <- mock_design %>% unite("sample", c(plate, shortname, run), remove = FALSE)
names(mock_design)
View(mock_design)
for(i in 1:dim(mitogenomes_data)[1]){
index = which(mitogenomes_data_COI$BOLD==mitogenomes_data$BOLD[i])
mitogenomes_data_COI$mitogenome[index] = mitogenomes_data$mitogenome[i]
mitogenomes_data_COI$mt_length[index] = mitogenomes_data$mt_length[i]
}
mitogenomes_data_COI$sp = mitogenomes_data_COI$mitogenome
for(i in 1:dim(mitogenomes_data_COI)[1]){
mitogenomes_data_COI$sp[i] = paste0("sp",as.character(i))
}
mitogenomes_data_COI$COI = mitogenomes_data_COI$mitogenome
